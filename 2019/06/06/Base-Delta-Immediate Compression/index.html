<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Base-Delta-Immediate Compression | 乌龙波霸七分甜</title><link rel="stylesheet" type="text/css" href="//fonts.loli.net/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=2.0.3"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=2.0.3"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Base-Delta-Immediate Compression</h1><a id="logo" href="/.">乌龙波霸七分甜</a><p class="description">每一个不曾起舞的日子，都是对生命的辜负</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="搜索"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">Base-Delta-Immediate Compression</h1><div class="post-meta"><a href="/2019/06/06/Base-Delta-Immediate Compression/#comments" class="comment-count"></a><p><span class="date">Jun 06, 2019</span><span><a href="/categories/论文阅读记录/" class="category">论文阅读记录</a></span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i>点击</i></i></span></p></div><div class="post-content"><p>Base-Delta-Immediate Compression:Practical Data Compression for On-Chip Caches。<a href="https://dl.acm.org/citation.cfm?id=2370870" target="_blank" rel="noopener">原文链接</a>很多基于软件的缓存压缩算法主要有两大缺点：造成很高的硬件复杂度；无法接受的解压延迟。本文提出了一种新的压缩算法Base-Delta-Immediate (B∆I) ，关键思想是：大多数cache line有一个特点，同一cache line中存储的数据差异很小。基于这一观察，cache line的数据可以用一个基值（Base）+ 一组差异值（Delta）来表示，所需存储空间必然会比原始cache line大小小得多。</p>
<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>为了缓解CPU和主存之间速度不匹配的问题，在主存与CPU之间插入一级或多级cache。然而cache并不是越大越好，虽然更大的cache通常会带来更少的cache miss，但是这种好处是以更长的访问延迟、更大的cache面积（昂贵）和更大的功耗为代价的。</p>
<p>基于这些限制，为了提高cache的利用率，可能会想到通过数据压缩来减少数据量，然而数据压缩并没有被现代商用微处理器作为一种提高有效缓存容量的方法，为什么？理想的缓存压缩技术应该是快速（压缩/解压延迟低）、简单（硬件复杂度低）、高效（高压缩率）的，而如果在商用微处理器中采用缓存压缩，会面临的最大障碍可能是解压延迟，解压与压缩不同，压缩是在缓存写入时(在提供关键字之后)在后台进行的，而解压缩位于cache hit的关键路径上，在此路径上最小化延迟对于性能非常重要。</p>
<p>因此，快速、简单、高效的缓存压缩方案，不可兼得，怎么办？只能权衡得到最佳方案，要么压缩率低、要么硬件复杂度高、要么解压延迟高，总会有缺陷，方案是否可行就看好处是否大于坏处，为了在降低硬件复杂度和解压缩延迟的同时达到显著的压缩比，本文提出了一种新的缓存压缩技术Base-Delta-Immediate(B∆I)压缩。</p>
<h2 id="BASE-DELTA-ENCODING-BASIC-IDEA"><a href="#BASE-DELTA-ENCODING-BASIC-IDEA" class="headerlink" title="BASE + DELTA ENCODING: BASIC IDEA"></a>BASE + DELTA ENCODING: BASIC IDEA</h2><p>基于两个特点：</p>
<ol>
<li><p>数据在内存中分配的规律性（相似的数据值和类型分组在一起）。</p>
</li>
<li><p>缓存/内存数据的动态范围较低（例如，同一cache line的数据差异很小）。</p>
</li>
</ol>
<p>设计了Base+Delta 压缩方案，通过存储一个Base和一组Delta来减少冗余从而提高Cache line的利用率。接下来通过两个直观的例子来更好地理解。</p>
<p><img src="https://github.com/Malizhen/Malizhen.github.io/blob/master/images/BDI%EF%BC%9ABase-Delta-Immediate%20Compression/1.png?raw=true" alt="images"></p>
<p> 应用程序h264ref的32-byte cache line利用Base+Delta 方案压缩如上图所示，该cache line包含一组（8个）以4字节整数形式存储的窄值。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">窄值是使用大数据类型存储的小值。例如，一个one-byte的值存储为一个four-byte整型数。程序员通常在各种数据结构中以最坏的情况为标准提供数据类型，即使大多数数值可能适合较小的数据类型。</span><br></pre></td></tr></table></figure>

<p>从Figure 3我们看到，cache line通过一个全0的base+一组八个1-byte的差异值即可表示所有存储的数值，只要4+8*1共12 byte就能表示整个cache line，这样消除冗余之后相比原来节省了20 byte的空间。看到这里就很容易联想到一个问题，如果说base的byte数太大，差异值节省出来的空间不够多，那么压缩还不如不压缩对不对？这个问题作者在下文考虑到了，base数目、base字节数、差异值的字节数多少才最合适？选择哪个value做base效果会一样吗？不一样的话那如何确定呢？都是我们需要考虑权衡的点。</p>
<p><img src="https://github.com/Malizhen/Malizhen.github.io/blob/master/images/BDI%EF%BC%9ABase-Delta-Immediate%20Compression/2.png?raw=true" alt="images"></p>
<p>由Figure 4，在perlbench应用程序负载上，同样是一个32-byte的cache line，存储的是pointer，可以看到，同一cache line的pointer值依然具有很高的相似度。</p>
<p>注意：虽然这里例子使用的是32-byte的cache line，最后实验评估部分有考虑更常见的64-byte cache line。</p>
<h3 id="Compression-Algorithm"><a href="#Compression-Algorithm" class="headerlink" title="Compression Algorithm"></a>Compression Algorithm</h3><p>关于该算法的具体描述，论文里面给出了公式（貌似有误，反了），也很容易理解，就是通过简单的向量减法得到Delta。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">∆i = Vi - B* ，其中V表示原始值的集合，∆表示差异值的集合，B*表示base值，若cache line的大小为C byte，其中每个value的大小为k byte，那么i的取值为1~C/k</span><br></pre></td></tr></table></figure>

<p>这里有两个观察：</p>
<ol>
<li><p>若存在任意一个Vi和所选base相似度为0，即Delta(i)的大小等于k，那么该缓存行不能压缩。因为本来引入base就加重了开销，压缩效果不好不如不压缩。</p>
</li>
<li><p>如何确定哪个value被选为base？要么Vi的最小值或最大值，要么中间值，被认为是最佳的。理论上是这样的，实际上的做法呢？</p>
</li>
</ol>
<p>我们除了确定base，还需要确定k，即每个value的大小，决定了一个cache line能容纳多少个value。</p>
<h4 id="Determining-k"><a href="#Determining-k" class="headerlink" title="Determining k"></a>Determining k</h4><p>k在2、4、8之间选择最佳压缩率的k值。选择2、4、8是因为几乎所有由各种编程语言支持的基本数据类型都有这三种大小之一。</p>
<h4 id="Determining-B"><a href="#Determining-B" class="headerlink" title="Determining B*"></a>Determining B*</h4><p>B*可以依据上述观察2来选取，然而，用这种方式寻找base需要计算原始集合的最大value与最小value，这会大大增加硬件的逻辑复杂度，并且会明显增加压缩延迟。所以为了简单起见，选择第一个value作为base即可，并且实验表明，压缩率相比选择理论最优base降低仅仅0.4%，很微不足道了，并且还不会增加硬件复杂度以及压缩延迟。</p>
<h3 id="Decompression-Algorithm"><a href="#Decompression-Algorithm" class="headerlink" title="Decompression Algorithm"></a>Decompression Algorithm</h3><p>通过B*和∆的值能够计算得到V，实现解压：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Vi = ∆i + B*</span><br></pre></td></tr></table></figure>

<p>因此，cache line中的值可以使用SIMD-style的向量加法器并行计算得到。即使用一组简单的加法器，可以在执行整数向量加法所需的时间内解压缩整个cache line。</p>
<h2 id="B∆I-COMPRESSION"><a href="#B∆I-COMPRESSION" class="headerlink" title="B∆I COMPRESSION"></a>B∆I COMPRESSION</h2><p>前一部分介绍了Base + Delta，以此为基础怎样能够更完善我们的压缩算法呢？</p>
<p>因为尽管B+∆被证明适用于大多数的应用程序，但是不可能所有的cache line都能用这种形式来表示，有一些基准测试压缩率就不见得好，比如mcf。这是因为有些应用程序在同一cache line中间可能混合有不同类型的数据，比如指针和1-byte的整数。这种情况下，很显然，如果我们选取多个base，一种类型一个base的话是不是压缩效果会好很多呢？</p>
<p><img src="https://github.com/Malizhen/Malizhen.github.io/blob/master/images/BDI%EF%BC%9ABase-Delta-Immediate%20Compression/3.png?raw=true" alt="images"></p>
<p>如Figure 5所示，我们发现对于在同一cache line可能存储着不同类型的数据的应用程序，多个base压缩效果会更好，但是这会造成更大的base存储开销，所以，存在一个<strong>tradeoff</strong>，因为显然不是多个base一定会更好，那么选取多少个base才是最优的呢？</p>
<p>光说都是没有依据的，通过实验来说话，作者设计了一个实验，评估了选择不同数量base(使用贪婪算法依次选择次优base)的有效压缩比，Figure 6展示了实验结果。</p>
<p><img src="https://github.com/Malizhen/Malizhen.github.io/blob/master/images/BDI%EF%BC%9ABase-Delta-Immediate%20Compression/4.png?raw=true" alt="images"></p>
<p>结果表明，就有效压缩比而言，经验上最优的base个数是2，虽然少数benchmark在1或3个base上也有最优，最后的结论还是B+∆在两个base的情况下，性能明显优于B+∆在base为1时(压缩比平均为1.51:1.40)，说明值得考虑实现。结果还表明有两个以上的base并不会为这些工作负载提供额外的压缩比改进，因为存储更多的base的开销要高于压缩更多cache line的好处。</p>
<p>注意：Figure 6中我们发现有0个base，这很必要，因为如果不考虑0个base，对于比如说最简单的全0数据，如果使用简单的压缩去冗余，不需要base，直接压缩到1byte，而base越多，显然，压缩率越低，并且增大存储开销。</p>
<p>那么，如何高效地找到两个base？不增加硬件的复杂度，或者说如何以最小的硬件复杂度寻找两个base来获得最大的压缩好处？下一节介绍</p>
<h3 id="B∆I-Refining-B-∆-with-Two-Bases-and-Minimal-Complexity"><a href="#B∆I-Refining-B-∆-with-Two-Bases-and-Minimal-Complexity" class="headerlink" title="B∆I: Refining B+∆ with Two Bases and Minimal Complexity"></a>B∆I: Refining B+∆ with Two Bases and Minimal Complexity</h3><p>我们发现，第二个base直接设置为0能够和任意选取任何一个vaule作为第二个base一样，为什么会这样？因为大多数情况下，是动态范围较小的宽值（比如指针）与窄值（比如小整数）混合，那么第一个base可以使用base+delta编码压缩动态范围较低的宽值，而第二个0 base则可以有效地压缩窄值。基于这一观察，我们额外增加一个隐式（implicit）的0 base来改进B+∆，称为Base-Delta-Immediate或B∆I压缩。</p>
<p>那么两个base的B+∆好还是B∆I好呢？又存在<strong>tradeoff</strong>。显然，B∆I有一个base是隐式的0，存储开销更小，这意味着对于用这两种技术都可压缩的cache line，B∆I的平均压缩率可能更高。有两个base的B+∆需要更多的存储空间来存储第二个base，但是可以压缩更多的cache line，因为base可以是任何value，从中选择最佳。到底哪个好呢？可能取决于cache line的模式，甲之砒霜，乙之蜜糖。关键时刻依然还是得实验来说话</p>
<p><img src="https://github.com/Malizhen/Malizhen.github.io/blob/master/images/BDI%EF%BC%9ABase-Delta-Immediate%20Compression/5.png?raw=true" alt="images"></p>
<p>Figure 7表明，虽然有个别负载B+∆的表现比B∆I好，但是总体来说还是B∆I的压缩比（1.53）高于B+∆（1.51），虽然不是高太多，但是考虑到B+∆有两个base，那就有比B∆I更复杂的硬件机制，所以认为缓存压缩设计还是应该基于B∆I的思想。</p>
<h2 id="Design"><a href="#Design" class="headerlink" title="Design"></a>Design</h2><h3 id="Compress"><a href="#Compress" class="headerlink" title="Compress"></a>Compress</h3><p>在具体的设计中，所有的可能压缩大小是静态已知的，如Table 2。如果cache line有多个压缩选项可用(例如，8-byte base 1-byte ∆或者Zeros压缩)，则Compression Selection 选择压缩cache line大小最小的一个（即选择压缩率最高的）。基于Table 2选择合适的压缩大小，Figure 8中所有压缩单元可并发执行。</p>
<p><img src="https://github.com/Malizhen/Malizhen.github.io/blob/master/images/BDI%EF%BC%9ABase-Delta-Immediate%20Compression/7.png?raw=true" alt="images"></p>
<p> <img src="https://github.com/Malizhen/Malizhen.github.io/blob/master/images/BDI%EF%BC%9ABase-Delta-Immediate%20Compression/8.png?raw=true" alt="images"> </p>
<p>Figure 9展示了32-byte的cache line在8-byte-base 1-byte-∆时压缩单元的情况，每个V通过减法器进行运算之后，判断是否每个V的运算结果∆前七位均为0或者1，如果是的话，cache line能够以该种模式（8-byte-base 1-byte-∆）存储，否则，说明至少有一个∆不能用1-byte表示，那么不压缩该cache line。</p>
<p><img src="https://github.com/Malizhen/Malizhen.github.io/blob/master/images/BDI%EF%BC%9ABase-Delta-Immediate%20Compression/6.png?raw=true" alt="images"></p>
<h3 id="Decompress"><a href="#Decompress" class="headerlink" title="Decompress"></a>Decompress</h3><p>解压的硬件设计很简单，如上文描述一样，就是一个减法器。如下图所示</p>
<p><img src="https://github.com/Malizhen/Malizhen.github.io/blob/master/images/BDI%EF%BC%9ABase-Delta-Immediate%20Compression/9.png?raw=true" alt="imges"></p>
<p>关于实现的更多细节，以及实验部分，如果感兴趣的话可以阅读原文，本文的分析重在了解基本思想。</p>
</div><div class="post-copyright"><blockquote><p>原文作者: malizhen</p><p>原文链接: <a href="http://malizhen.github.io/2019/06/06/Base-Delta-Immediate Compression/">http://malizhen.github.io/2019/06/06/Base-Delta-Immediate Compression/</a></p><p>版权声明: 转载请注明出处（必须保留原文作者署名及原文链接）</p></blockquote></div><div class="tags"><a href="/tags/compression-algorithm/">compression algorithm</a></div><div class="post-share"><div class="social-share"><span>分享到:</span></div></div><div class="post-nav"><a href="/2019/06/10/VSCodeRemote-SSH配置/" class="pre">VSCode:Remote-SSH配置</a><a href="/2019/06/06/重庆四人游/" class="next">重庆四人游</a></div><div id="comments"></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">文章目录</i></div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#背景"><span class="toc-text">背景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#BASE-DELTA-ENCODING-BASIC-IDEA"><span class="toc-text">BASE + DELTA ENCODING: BASIC IDEA</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Compression-Algorithm"><span class="toc-text">Compression Algorithm</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Determining-k"><span class="toc-text">Determining k</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Determining-B"><span class="toc-text">Determining B*</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Decompression-Algorithm"><span class="toc-text">Decompression Algorithm</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#B∆I-COMPRESSION"><span class="toc-text">B∆I COMPRESSION</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#B∆I-Refining-B-∆-with-Two-Bases-and-Minimal-Complexity"><span class="toc-text">B∆I: Refining B+∆ with Two Bases and Minimal Complexity</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Design"><span class="toc-text">Design</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Compress"><span class="toc-text">Compress</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Decompress"><span class="toc-text">Decompress</span></a></li></ol></li></ol></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/07/23/PCM-ISSCC-2012-4GB配置文件参数解析/">PCM_ISSCC_2012_4GB配置文件参数解析</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/07/23/BDI源码分析/">BDI源码分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/07/23/FPC源码分析/">FPC源码分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/07/18/阶段总结/">阶段总结</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/07/11/SubArray.cpp源码分析/">SubArray.cpp分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/07/04/Compression Architecture for Bit-write Reduction/">Compression Architecture for Bit-write Reduction</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/07/01/Frequent Pattern Compression/">Frequent Pattern Compression</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/06/28/Gem5简介/">Gem5简介</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/06/26/Data Compression Techniques总结/">Data Compression Techniques</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/06/12/DRAM层次结构/">DRAM层次结构</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-gui"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/存储/">存储</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/搭建与配置/">搭建与配置</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/模拟器/">模拟器</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/源码分析/">源码分析</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/论文阅读记录/">论文阅读记录</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/随笔/">随笔</a><span class="category-list-count">1</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> 标签</i></div><div class="tagcloud"><a href="/tags/compression/" style="font-size: 15px;">compression</a> <a href="/tags/compression-algorithm/" style="font-size: 15px;">compression algorithm</a> <a href="/tags/DRAM/" style="font-size: 15px;">DRAM</a> <a href="/tags/nvmain/" style="font-size: 15px;">nvmain</a> <a href="/tags/VSCode/" style="font-size: 15px;">VSCode</a> <a href="/tags/旅游/" style="font-size: 15px;">旅游</a> <a href="/tags/gem5/" style="font-size: 15px;">gem5</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> 归档</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">七月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">六月 2019</a></li></ul></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">网站地图</a> |  <a href="/atom.xml">订阅本站</a> |  <a href="/about/">联系博主</a></p><p>本站总访问量：<i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>次，本站总访客数:<i id="busuanzi_container_site_uv"><i id="busuanzi_value_site_uv"></i></i>人</p><p><span> Copyright &copy;<a href="/." rel="nofollow">malizhen.</a></span><span> Theme by<a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake.</a></span><span> Count by<a href="http://busuanzi.ibruce.info/"> busuanzi.</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span></p></div></div></div><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script type="text/javascript" src="/js/search.json.js?v=2.0.3"></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.3" async></script><link rel="stylesheet" type="text/css" href="/share/css/share.css"><script type="text/javascript" src="/share/js/social-share.js" charset="utf-8"></script><script type="text/javascript" src="/share/js/qrcode.js" charset="utf-8"></script></body></html>